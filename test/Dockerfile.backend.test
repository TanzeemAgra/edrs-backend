# EDRS Backend Test Container
# Optimized for automated testing with minimal overhead

FROM python:3.11-slim

# Set test environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    DEBIAN_FRONTEND=noninteractive \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    TESTING=true \
    ENVIRONMENT=test

# Install system dependencies for testing
RUN apt-get update && apt-get install -y \
    postgresql-client \
    build-essential \
    libpq-dev \
    curl \
    wget \
    git \
    && rm -rf /var/lib/apt/lists/*

# Set work directory
WORKDIR /app

# Create test directories
RUN mkdir -p /app/logs /app/static /app/media /app/test-reports

# Copy requirements and install dependencies
COPY backend/requirements.txt .

# Install Python dependencies
RUN pip install --upgrade pip && \
    pip install -r requirements.txt

# Install additional test dependencies
RUN pip install \
    pytest==7.4.3 \
    pytest-django==4.5.2 \
    pytest-cov==4.1.0 \
    pytest-xdist==3.3.1 \
    pytest-mock==3.12.0 \
    factory-boy==3.3.0 \
    faker==19.12.0 \
    coverage==7.3.2 \
    django-test-plus==2.2.2 \
    model-bakery==1.17.0

# Copy backend project
COPY backend/ .

# Create test database wait script
RUN echo '#!/bin/bash\n\
echo "â³ Waiting for test databases..."\n\
while ! pg_isready -h postgres-test -p 5432 -U test_user; do\n\
  echo "â³ PostgreSQL test database not ready, waiting..."\n\
  sleep 2\n\
done\n\
echo "âœ… PostgreSQL test database is ready!"\n\
\n\
# Test Redis connection\n\
while ! redis-cli -h redis-test -p 6379 -a test_redis_123 ping > /dev/null 2>&1; do\n\
  echo "â³ Redis test cache not ready, waiting..."\n\
  sleep 2\n\
done\n\
echo "âœ… Redis test cache is ready!"\n\
\n\
echo "ðŸ§ª All test services are ready!"' > /app/wait_for_test_services.sh && chmod +x /app/wait_for_test_services.sh

# Create test data setup script
RUN echo '#!/bin/bash\n\
echo "ðŸ—‚ï¸  Setting up test data..."\n\
\n\
# Run migrations\n\
python manage.py migrate --verbosity=0\n\
\n\
# Create test superuser\n\
python manage.py shell -c "\n\
from django.contrib.auth import get_user_model;\n\
User = get_user_model();\n\
if not User.objects.filter(username='\''testadmin'\'').exists():\n\
    User.objects.create_superuser('\''testadmin'\'', '\''testadmin@test.local'\'', '\''testpass123'\'');\n\
    print('\''âœ… Test admin user created'\'');\n\
else:\n\
    print('\''â„¹ï¸  Test admin user already exists'\'');\n\
"\n\
\n\
# Create test regular user\n\
python manage.py shell -c "\n\
from django.contrib.auth import get_user_model;\n\
User = get_user_model();\n\
if not User.objects.filter(username='\''testuser'\'').exists():\n\
    User.objects.create_user('\''testuser'\'', '\''testuser@test.local'\'', '\''testpass123'\'');\n\
    print('\''âœ… Test user created'\'');\n\
else:\n\
    print('\''â„¹ï¸  Test user already exists'\'');\n\
"\n\
\n\
# Load test fixtures if available\n\
if [ -d "test/fixtures" ]; then\n\
  echo "ðŸ”„ Loading test fixtures..."\n\
  python manage.py loaddata test/fixtures/*.json || echo "âš ï¸  No test fixtures found"\n\
fi\n\
\n\
echo "âœ… Test data setup complete!"' > /app/setup_test_data.sh && chmod +x /app/setup_test_data.sh

# Create test runner script
RUN echo '#!/bin/bash\n\
echo "ðŸ§ª Running EDRS Backend Tests..."\n\
\n\
# Set test environment\n\
export DJANGO_SETTINGS_MODULE=core.settings.test\n\
export TESTING=true\n\
\n\
# Wait for services\n\
./wait_for_test_services.sh\n\
\n\
# Setup test data\n\
./setup_test_data.sh\n\
\n\
# Run tests with coverage\n\
echo "ðŸ§ª Executing test suite..."\n\
pytest \\\n\
  --verbose \\\n\
  --cov=. \\\n\
  --cov-report=html:/app/test-reports/coverage-html \\\n\
  --cov-report=xml:/app/test-reports/coverage.xml \\\n\
  --cov-report=term-missing \\\n\
  --junit-xml=/app/test-reports/junit.xml \\\n\
  --maxfail=5 \\\n\
  --tb=short \\\n\
  apps/\n\
\n\
# Capture exit code\n\
TEST_EXIT_CODE=$?\n\
\n\
echo "ðŸ“Š Test Results Summary:"\n\
echo "Exit Code: $TEST_EXIT_CODE"\n\
echo "Reports available in: /app/test-reports/"\n\
\n\
exit $TEST_EXIT_CODE' > /app/run_tests.sh && chmod +x /app/run_tests.sh

# Set permissions
RUN chmod +x /app/manage.py

# Expose test port
EXPOSE 8000

# Health check for test environment
HEALTHCHECK --interval=10s --timeout=5s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8000/health/ || exit 1

# Test environment labels
LABEL edrs.environment=test
LABEL edrs.component=backend
LABEL edrs.testing=true

# Default command for test backend
CMD ["./run_tests.sh"]