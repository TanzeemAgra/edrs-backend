# EDRS Test Environment - Smart Docker Configuration
# Complete isolation for automated testing without affecting production/development
version: '3.8'

services:
  # PostgreSQL Test Database (Isolated)
  postgres-test:
    image: postgres:15-alpine
    container_name: edrs_postgres_test
    environment:
      POSTGRES_DB: ${TEST_POSTGRES_DB:-edrs_test_db}
      POSTGRES_USER: ${TEST_POSTGRES_USER:-test_user}
      POSTGRES_PASSWORD: ${TEST_POSTGRES_PASSWORD:-test_password_123}
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "${TEST_POSTGRES_PORT:-5434}:5432"
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./test/sql/init:/docker-entrypoint-initdb.d
    networks:
      - edrs_test_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${TEST_POSTGRES_USER:-test_user} -d ${TEST_POSTGRES_DB:-edrs_test_db}"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: "no"  # Don't auto-restart for testing
    labels:
      - "edrs.environment=test"
      - "edrs.component=database"

  # MongoDB Test Database (Isolated)
  mongodb-test:
    image: mongo:7.0
    container_name: edrs_mongodb_test
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${TEST_MONGO_USER:-test_admin}
      MONGO_INITDB_ROOT_PASSWORD: ${TEST_MONGO_PASSWORD:-test_password_123}
      MONGO_INITDB_DATABASE: ${TEST_MONGO_DB:-edrs_test_mongo}
    ports:
      - "${TEST_MONGO_PORT:-27019}:27017"
    volumes:
      - mongodb_test_data:/data/db
      - ./test/mongo/init:/docker-entrypoint-initdb.d
    networks:
      - edrs_test_network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: "no"
    labels:
      - "edrs.environment=test"
      - "edrs.component=document-database"

  # Redis Test Cache (Isolated)
  redis-test:
    image: redis:7-alpine
    container_name: edrs_redis_test
    ports:
      - "${TEST_REDIS_PORT:-6381}:6379"
    volumes:
      - redis_test_data:/data
    networks:
      - edrs_test_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: "no"
    command: redis-server --appendonly yes --requirepass ${TEST_REDIS_PASSWORD:-test_redis_123}
    labels:
      - "edrs.environment=test"
      - "edrs.component=cache"

  # Django Backend Test (Isolated)
  backend-test:
    build:
      context: ..
      dockerfile: test/Dockerfile.backend.test
      args:
        - TESTING=true
    container_name: edrs_backend_test
    environment:
      # Test Database Configuration
      DATABASE_URL: postgresql://${TEST_POSTGRES_USER:-test_user}:${TEST_POSTGRES_PASSWORD:-test_password_123}@postgres-test:5432/${TEST_POSTGRES_DB:-edrs_test_db}
      MONGO_URL: mongodb://${TEST_MONGO_USER:-test_admin}:${TEST_MONGO_PASSWORD:-test_password_123}@mongodb-test:27017/${TEST_MONGO_DB:-edrs_test_mongo}?authSource=admin
      REDIS_URL: redis://:${TEST_REDIS_PASSWORD:-test_redis_123}@redis-test:6379/0
      
      # Django Test Configuration
      DJANGO_SETTINGS_MODULE: core.settings.test
      DEBUG: "False"  # Production-like testing
      SECRET_KEY: ${TEST_SECRET_KEY:-test-secret-key-for-automated-testing-only}
      
      # Test-specific CORS
      CORS_ALLOWED_ORIGINS: http://frontend-test:3000,http://localhost:${TEST_FRONTEND_PORT:-3002}
      CORS_ALLOW_ALL_ORIGINS: "True"
      
      # API Configuration
      API_VERSION: ${API_VERSION:-v1}
      API_PREFIX: ${API_PREFIX:-api}
      
      # Test Security
      ALLOWED_HOSTS: localhost,127.0.0.1,backend-test,${TEST_BACKEND_HOST:-0.0.0.0}
      
      # Environment Identification
      ENVIRONMENT: test
      TESTING: "True"
      NODE_ENV: test
      
      # OpenAI Test Configuration (Mock)
      OPENAI_API_KEY: ${TEST_OPENAI_API_KEY:-test_mock_key}
      ENABLE_OPENAI_INTEGRATION: ${TEST_ENABLE_AI:-False}
      
      # Test Feature Flags
      ENABLE_RATE_LIMITING: "False"  # Disable for faster testing
      ENABLE_AUTHENTICATION: "True"
      ENABLE_PERMISSIONS: "True"
      ENABLE_MOCK_DATA: "True"
      ENABLE_TEST_ENDPOINTS: "True"
    ports:
      - "${TEST_BACKEND_PORT:-8002}:8000"
    volumes:
      - ../backend:/app
      - /app/venv  # Exclude virtual environment
      - test_static_files:/app/static
      - test_media_files:/app/media
      - test_logs:/app/logs
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    networks:
      - edrs_test_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: "no"
    labels:
      - "edrs.environment=test"
      - "edrs.component=backend"
    command: >
      sh -c "
        echo 'Starting Test Backend Environment...' &&
        python manage.py wait_for_db &&
        echo 'Running database migrations...' &&
        python manage.py migrate &&
        echo 'Creating test fixtures...' &&
        python manage.py loaddata test/fixtures/*.json || echo 'No fixtures found' &&
        echo 'Creating test users...' &&
        python manage.py shell -c \"from django.contrib.auth import get_user_model; User = get_user_model(); User.objects.filter(username='testadmin').exists() or User.objects.create_superuser('testadmin', 'test@example.com', 'testpass123'); User.objects.filter(username='testuser').exists() or User.objects.create_user('testuser', 'user@example.com', 'testpass123')\" &&
        echo 'Running automated tests...' &&
        python manage.py test --verbosity=2 || true &&
        echo 'Starting test server...' &&
        python manage.py runserver 0.0.0.0:8000
      "

  # React Frontend Test (Isolated)
  frontend-test:
    build:
      context: ..
      dockerfile: test/Dockerfile.frontend.test
    container_name: edrs_frontend_test
    environment:
      # Test API Configuration
      VITE_API_URL: http://localhost:${TEST_BACKEND_PORT:-8002}
      VITE_API_BASE_URL: http://backend-test:8000
      
      # Test Environment
      NODE_ENV: test
      VITE_ENVIRONMENT: test
      CI: "true"  # Continuous Integration mode
      
      # Test Feature Flags
      VITE_ENABLE_DEVTOOLS: "false"
      VITE_ENABLE_DEBUG: "true"
      VITE_ENABLE_MOCKING: "true"
      
      # Test App Configuration
      VITE_APP_NAME: ${TEST_APP_NAME:-EDRS Test}
      VITE_APP_VERSION: ${APP_VERSION:-1.0.0-test}
    ports:
      - "${TEST_FRONTEND_PORT:-3002}:3000"
    volumes:
      - ../frontend:/app
      - /app/node_modules  # Exclude node_modules
      - /app/dist  # Exclude build output
    depends_on:
      - backend-test
    networks:
      - edrs_test_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 45s
    restart: "no"
    labels:
      - "edrs.environment=test"
      - "edrs.component=frontend"
    command: >
      sh -c "
        echo 'Starting Test Frontend Environment...' &&
        npm ci &&
        echo 'Running frontend tests...' &&
        npm run test -- --watchAll=false --coverage || true &&
        echo 'Building test application...' &&
        npm run build &&
        echo 'Starting test server...' &&
        npm run preview -- --host 0.0.0.0 --port 3000
      "

  # Test Runner Service (Automated Testing)
  test-runner:
    build:
      context: ..
      dockerfile: test/Dockerfile.test-runner
    container_name: edrs_test_runner
    environment:
      TEST_BACKEND_URL: http://backend-test:8000
      TEST_FRONTEND_URL: http://frontend-test:3000
      TEST_DATABASE_URL: postgresql://${TEST_POSTGRES_USER:-test_user}:${TEST_POSTGRES_PASSWORD:-test_password_123}@postgres-test:5432/${TEST_POSTGRES_DB:-edrs_test_db}
      TEST_SUITE: ${TEST_SUITE:-full}  # full, unit, integration, e2e
      TEST_PARALLEL: ${TEST_PARALLEL:-true}
      TEST_VERBOSE: ${TEST_VERBOSE:-true}
    volumes:
      - ../backend:/backend
      - ../frontend:/frontend
      - ./test/reports:/reports
      - ./test/scripts:/scripts
    depends_on:
      backend-test:
        condition: service_healthy
      frontend-test:
        condition: service_healthy
    networks:
      - edrs_test_network
    restart: "no"
    labels:
      - "edrs.environment=test"
      - "edrs.component=test-runner"
    profiles:
      - testing  # Only run when explicitly requested

  # Test Database Manager (Data Management)
  test-db-manager:
    image: postgres:15-alpine
    container_name: edrs_test_db_manager
    environment:
      PGPASSWORD: ${TEST_POSTGRES_PASSWORD:-test_password_123}
    volumes:
      - ./test/scripts/db:/scripts
      - test_backups:/backups
    networks:
      - edrs_test_network
    restart: "no"
    labels:
      - "edrs.environment=test"
      - "edrs.component=db-manager"
    profiles:
      - maintenance
    command: >
      sh -c "
        echo 'ğŸ—„ï¸  Test Database Manager Ready' &&
        sleep infinity
      "

# Persistent Test Volumes (Isolated from dev/prod)
volumes:
  postgres_test_data:
    driver: local
    name: edrs_postgres_test_data
  mongodb_test_data:
    driver: local
    name: edrs_mongodb_test_data
  redis_test_data:
    driver: local
    name: edrs_redis_test_data
  test_static_files:
    driver: local
    name: edrs_test_static
  test_media_files:
    driver: local
    name: edrs_test_media
  test_logs:
    driver: local
    name: edrs_test_logs
  test_backups:
    driver: local
    name: edrs_test_backups

# Isolated Test Network
networks:
  edrs_test_network:
    driver: bridge
    name: edrs_test_network
    ipam:
      driver: default
      config:
        - subnet: 172.25.0.0/16
          gateway: 172.25.0.1
    labels:
      - "edrs.environment=test"
      - "edrs.network=isolated"