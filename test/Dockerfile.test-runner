# EDRS Test Runner Container
# Orchestrates comprehensive testing across all services

FROM python:3.11-slim

# Set test environment
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    TESTING=true \
    ENVIRONMENT=test

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    postgresql-client \
    redis-tools \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js for frontend testing
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt-get install -y nodejs

# Set work directory
WORKDIR /test-runner

# Install Python testing tools
RUN pip install --upgrade pip && \
    pip install \
        requests==2.31.0 \
        pytest==7.4.3 \
        pytest-html==4.1.1 \
        pytest-json-report==1.5.0 \
        psutil==5.9.6 \
        docker==6.1.3

# Create test runner directories
RUN mkdir -p /reports /scripts /config

# Copy test scripts
COPY test/scripts/ /scripts/
RUN chmod +x /scripts/*.sh

# Create comprehensive test runner
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "ðŸ§ª EDRS Comprehensive Test Runner Starting..."\n\
echo "============================================"\n\
\n\
# Configuration\n\
BACKEND_URL=${TEST_BACKEND_URL:-"http://backend-test:8000"}\n\
FRONTEND_URL=${TEST_FRONTEND_URL:-"http://frontend-test:3000"}\n\
TEST_SUITE=${TEST_SUITE:-"full"}\n\
PARALLEL=${TEST_PARALLEL:-"true"}\n\
VERBOSE=${TEST_VERBOSE:-"true"}\n\
\n\
# Create report directory\n\
mkdir -p /reports/{backend,frontend,integration,performance}\n\
\n\
# Wait for services\n\
echo "â³ Waiting for all test services..."\n\
/scripts/wait_for_services.sh\n\
\n\
# Service health check\n\
echo "ðŸ” Running service health checks..."\n\
/scripts/health_check.sh\n\
\n\
# Initialize test tracking\n\
TESTS_PASSED=0\n\
TESTS_FAILED=0\n\
START_TIME=$(date +%s)\n\
\n\
# Backend Tests\n\
if [ "$TEST_SUITE" = "full" ] || [ "$TEST_SUITE" = "backend" ]; then\n\
  echo "ðŸ”§ Running Backend Tests..."\n\
  if /scripts/run_backend_tests.sh; then\n\
    echo "âœ… Backend tests passed"\n\
    ((TESTS_PASSED++))\n\
  else\n\
    echo "âŒ Backend tests failed"\n\
    ((TESTS_FAILED++))\n\
  fi\n\
fi\n\
\n\
# Frontend Tests\n\
if [ "$TEST_SUITE" = "full" ] || [ "$TEST_SUITE" = "frontend" ]; then\n\
  echo "ðŸŽ¨ Running Frontend Tests..."\n\
  if /scripts/run_frontend_tests.sh; then\n\
    echo "âœ… Frontend tests passed"\n\
    ((TESTS_PASSED++))\n\
  else\n\
    echo "âŒ Frontend tests failed"\n\
    ((TESTS_FAILED++))\n\
  fi\n\
fi\n\
\n\
# Integration Tests\n\
if [ "$TEST_SUITE" = "full" ] || [ "$TEST_SUITE" = "integration" ]; then\n\
  echo "ðŸ”— Running Integration Tests..."\n\
  if /scripts/run_integration_tests.sh; then\n\
    echo "âœ… Integration tests passed"\n\
    ((TESTS_PASSED++))\n\
  else\n\
    echo "âŒ Integration tests failed"\n\
    ((TESTS_FAILED++))\n\
  fi\n\
fi\n\
\n\
# Performance Tests\n\
if [ "$TEST_SUITE" = "full" ] || [ "$TEST_SUITE" = "performance" ]; then\n\
  echo "âš¡ Running Performance Tests..."\n\
  if /scripts/run_performance_tests.sh; then\n\
    echo "âœ… Performance tests passed"\n\
    ((TESTS_PASSED++))\n\
  else\n\
    echo "âŒ Performance tests failed"\n\
    ((TESTS_FAILED++))\n\
  fi\n\
fi\n\
\n\
# Generate consolidated report\n\
END_TIME=$(date +%s)\n\
DURATION=$((END_TIME - START_TIME))\n\
\n\
echo "\nðŸ† EDRS Test Suite Complete"\n\
echo "=========================="\n\
echo "Duration: ${DURATION}s"\n\
echo "Tests Passed: $TESTS_PASSED"\n\
echo "Tests Failed: $TESTS_FAILED"\n\
echo "Success Rate: $(( TESTS_PASSED * 100 / (TESTS_PASSED + TESTS_FAILED) ))%"\n\
\n\
# Generate HTML report\n\
/scripts/generate_report.sh "$TESTS_PASSED" "$TESTS_FAILED" "$DURATION"\n\
\n\
# Exit with proper code\n\
if [ $TESTS_FAILED -eq 0 ]; then\n\
  echo "ðŸŽ‰ All test suites passed!"\n\
  exit 0\n\
else\n\
  echo "ðŸ’¥ $TESTS_FAILED test suite(s) failed!"\n\
  exit 1\n\
fi' > /test-runner/run_all_tests.sh && chmod +x /test-runner/run_all_tests.sh

# Test runner labels
LABEL edrs.environment=test
LABEL edrs.component=test-runner
LABEL edrs.testing=true

# Default command
CMD ["./run_all_tests.sh"]